procedure simseur
lc_tark2=.f.
lc_tark=.f.
release window koodit
release window codes
select ncsp_koo
use
use ncsp_koo.dbf
SET FILTER TO NOT released
set order to code
seek sim_code
do while not eof()
 select ncsp_en
 set filter to reldate = ctod(space(8))
 if ncsp_koo.ncsp<>' '
   set order to ncsp
   seek ncsp_koo.ncsp
   if not found()
     set order to code_fin
     seek trim(ncsp_koo.code)
     if found()
        select ncsp_koo
        replace ncsp with ncsp_en.code
        wait window 'Error in mapping of '+trim(ncsp_koo.code)+ ' corrected, check result'
     else
       wait window 'Error in mapping to common version' nowait
     endif
     do simloc
     exit
   endif
 endif

 select ncsp_en
 set order to code_fin
 seek trim(ncsp_koo.code)
 if not found()
   set filter to
   seek trim(ncsp_koo.code)
 endif
 if found() and reldate<> ctod(space(8))
   replace ncsp_koo.ncsp with ncsp_en.subst
   set order to code
   seek ncsp_koo.ncsp
   if found()
     if ncsp_en.code_fin=' '
       replace ncsp_en.code_fin with ncsp_koo.code
       wait window nowait 'Mapping is modified to '+ncsp_koo.ncsp+', check the result'
     else
       append blank
       replace code with ncsp_koo.ncsp, code_fin with ncsp_koo.code, released with .f., text with ncsp_koo.english, usedate with ncsp_koo.usedate, chadate with date(), nc with .f. 
       if ncsp_en.text=' '
         replace ncsp_en.text with ncsp_koo.text_2
       endif
       wait window nowait 'The line has be added to NCSP combined version with mapping to '+ncsp_koo.ncsp+', check the result'
     endif
     lc_found=.t.       
   endif
   select ncsp_koo
   set order to code
   su_code=ncsp_koo.code
 *  seek sim_code
   select ncsp_en
   set order to code
   seek ncsp_koo.ncsp
   do simcheck
   exit
 endif
 if not found() or reldate <> ctod(space(8))
  lc_found=.f.
  if ncsp_koo.ncsp<>' '
    select ncsp_en
    set order to ncsp
    seek trim(ncsp_koo.ncsp)
    if found() 
      if code_fin=' ' or reldate <> ctod(space(8))
        replace code_fin with ncsp_koo.code
        wait window nowait 'Missing mapping was added to NCSP common version, check the result'
        lc_found=.t.
      else
        append blank
        replace code with ncsp_koo.ncsp, code_fin with ncsp_koo.code, released with .f., text with ncsp_koo.english, usedate with ncsp_koo.usedate, chadate with date(), nc with .f. 
        if ncsp_en.text=' '
          replace ncsp_en.text with ncsp_koo.text_2
        endif
        wait window nowait 'The line has be added to NCSP common version at location '+ncsp_koo.ncsp+', check the result'
        lc_found=.t.
      endif
      select ncsp_koo
      set order to code
      su_code=ncsp_koo.code
      select ncsp_en
      set order to code
      do simcheck
      exit
    endif
  endif
  if not lc_found
    select ncsp_en
    append blank
    replace code with ncsp_koo.code, code_fin with ncsp_koo.code, released with .f., text with ncsp_koo.english, usedate with ncsp_koo.usedate, chadate with date(), nc with .f. 
    if ncsp_en.text=' '
      replace ncsp_en.text with ncsp_koo.text_2
    endif
    wait window nowait 'The line has be added to NCSP common version without mapping at location '+ ncsp_koo.ncsp +', check the result'
  endif
  select ncsp_koo
  set order to code
  seek sim_code
  select ncsp_en
  set order to code
  seek ncsp_koo.ncsp
  do simcheck
  exit
 endif
 select ncsp_koo
 skip
 sim_code=ncsp_koo.code
enddo
if eof()
  select ncsp_en
  delete all for ncsp_en.ncsp=' ' and code_den=' ' and code_swe=' ' and code_nor=' ' and code_est=' ' and code_eng=' ' and code_fin=' ' and code_ice=' '
  pack
  do ncsp
endif
define window koodit from ala_y,3 to max_y,luv_x font  max_foty,  max_fosi Title 'NCSP-Finnish'
define window codes from ala_y,luv_x to max_y,max_x font max_foty,  max_fosi title 'NCSP-Common version'
return  
